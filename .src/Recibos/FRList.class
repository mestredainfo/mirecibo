' Gambas class file

' Copyright (C) 2004-2025 Murilo Gomes Julio
' SPDX-License-Identifier: GPL-2.0-only

' Mestre da Info
' Site: https://www.mestredainfo.com.br

Public sTipo As String = "pf"
Private $conecta As Connection

Private Function getIDCliente(id As Integer) As String
  
  Dim txt As String = ""
  Dim $conecta1 As Connection
  
  Try $conecta1.Close()
  $conecta1 = New Connection
  $conecta1.Type = "sqlite3"
  $conecta1.Host = FMain.dbPath 
  $conecta1.Name = FMain.dbName
  $conecta1.Open()
  
  Dim rs As Result = $conecta1.Exec("SELECT * FROM mi_clientes WHERE id=&1 AND tipo=&2", id, sTipo) 
  
  While (rs.Available)
    txt = rs!nome
    rs.MoveNext()
  Wend
  $conecta1.Close()
  
  Return txt   
  
End

Private Function formatMoeda(valor As String) As String
  
  'Dim a As String = Format(valor, "$,#.###")
  Dim a As String = Format(valor, "$#,##0.00")
  'If InStr(a, ",") = 0 Then 
    'a = a & ",00"
  'Endif
  
  Return a
  
End

Public Sub carregarDados()
  
  cv.Clear()
  
  Try $conecta.Close()
  $conecta = New Connection
  $conecta.Type = "sqlite3"
  $conecta.Host = FMain.dbPath 
  $conecta.Name = FMain.dbName
  $conecta.Open()
  
  Dim rs As Result = $conecta.Exec("SELECT * FROM mi_recibos WHERE tipo=&1", sTipo)
  
  While (rs.Available)
    cv.Add(rs!id, rs!id)
    If IsInteger(rs!nome) = True Then 
      cv[rs!id][1] = getIDCliente(rs!nome)
    Else 
      cv[rs!id][1] = rs!nome
    Endif 
    cv[rs!id][2] = formatMoeda(rs!total)
    cv[rs!id][3] = rs!datadevencimento
    rs.MoveNext()
  Wend
  $conecta.Close()
  
End

Public Sub Form_Open()
  
  cv.Columns.Count = 4
  cv.Columns[0].Text = "ID"
  cv.Columns[0].Width = 100
  cv.Columns[1].Text = "Nome"
  cv.Columns[1].Width = 200
  cv.Columns[2].Text = "Total"
  cv.Columns[2].Width = 150
  cv.Columns[3].Text = "Vencimento"
  cv.Columns[3].Width = 200
  cv.Header = True
  
  carregarDados()
  
End

Public Sub btnEditar_Click()
  
  cv_DblClick
  
End

Public Sub cv_DblClick()
  
  If Not IsNull(cv.Key) Then
    FRAdd.sTipo = sTipo
    FRAdd.sID = cv[cv.Key][0]
    FRAdd.ShowDialog()
  Endif
  
End

Public Sub btnExcluir_Click()
  
  If Message.Question(Subst("Deseja excluir o(s) &1 registro(s) selecionado(s)?", cv.Selection.Count), "Sim", "NÃ£o") = 1 Then 
    Try $conecta.Close()
    $conecta = New Connection
    $conecta.Type = "sqlite3"
    $conecta.Host = FMain.dbPath 
    $conecta.Name = FMain.dbName
    $conecta.Open()
    
    For Each row As Integer In cv.Selection
      $conecta.Exec("DELETE FROM mi_recibos WHERE id=&1 AND tipo=&2", row, sTipo)
    Next 
    
    $conecta.Close()
    
    cv.Remove(cv.Key)
    
    carregarDados()
  Endif 
  
End

Public Sub btnAdd_Click()
  
  FRAdd.sTipo = sTipo
  FRAdd.ShowDialog()
  
End
